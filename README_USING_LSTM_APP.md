![PadoGrid](https://github.com/padogrid/padogrid/raw/develop/images/padogrid-3d-16x16.png) [*PadoGrid*](https://github.com/padogrid) | [*Catalogs*](https://github.com/padogrid/catalog-bundles/blob/master/all-catalog.md) | [*Manual*](https://github.com/padogrid/padogrid/wiki) | [*FAQ*](https://github.com/padogrid/padogrid/wiki/faq) | [*Releases*](https://github.com/padogrid/padogrid/releases) | [*Templates*](https://github.com/padogrid/padogrid/wiki/Using-Bundle-Templates) | [*Pods*](https://github.com/padogrid/padogrid/wiki/Understanding-Padogrid-Pods) | [*Kubernetes*](https://github.com/padogrid/padogrid/wiki/Kubernetes) | [*Docker*](https://github.com/padogrid/padogrid/wiki/Docker) | [*Apps*](https://github.com/padogrid/padogrid/wiki/Apps) | [*Quick Start*](https://github.com/padogrid/padogrid/wiki/Quick-Start)

---

# Using LSTM App

This article describes how to use the LSTM app provided in this bundle with your own datasets to forecast future events. 

## Hazelcast Maps 

The `ml_lstm` app stores data in four (4) Hazelcast maps. The following shows the default maps. The first two (2) map names can be changed by specifying the `--map` option. The remaining ones are fixed.

1. `stocks` - This map stores observed data published by the simulator. The map name is changeable using the `--map` option.
2. `journal` - This is a journal event map that stores real-time data that is applied to the LSTM model for forecasting future events. The map name is changeable using the `--map` option.
3. `forecast` - Future events forecasted by LSTM. The key is the feature name and the value is a single numerical forecasted value.
4. `dna_status`  - The `ml_lstm` app reports the status of each LSTM model generation. You can monitor this map to verify the model state.

## Steps

### 1. Ingest observed data

Ingest your observed data into a Hazelcast map in the form of the following JSON object format. Keys can be any values as long as they are unique.

✏️  You can also use object types other than JSON such as `Portable` supported by Hazelcast Python. For using object types across languages, please see Hazelcast documention.

```json
{
  "time": "2023-07-26T09:00:00.000-0400",
  "temperature": 51.24816535314684,
  "pressure": 105.788532099418
}
```

- The `time` attribute must be in the format, `yyyy-MM-dd'T'HH:mm:ss.SSSZ`.
- Attributes that you want to forecast must be numerical values.

The data feed simulator conforms to the JSON object structure such that you can quickly test the LSTM app with your own data generated by the simulator. Please see the [simulator documentation](https://github.com/padogrid/bundle-none-app-simulator) for instructions.

✏️  The simulator is already installed by this bundle during the build steps.

### 2. Build LSTM model

Run `padogrid.bundle.hazelcast.ml.forecast_test_local` against your observed data by specifying the `--map` and `--feature` options. Also, specify the `--generate` option to generate a new model. Note that `--generate` overwrites the existing model and generates a new model.

```bash
cd_app ml_lstm
export PYTHONPATH=`pwd`/src/main/python
python -m padogrid.bundle.hazelcast.ml.forecast_test_local --generate --map mymap --feature temperature 
```

The above generates an LSTM model as follows.

```
cd_app ml_lstm
tree data/ml_results
```

Output:

```console
data/ml_results/
├── model_temperature-info-archive.json
├── model_temperature-info.json
├── model_temperature.h5
├── model_temperature.json
└── model_temperature.scaler
```

### 3. Save LSTM model

Copy the new model you generated to another directory so that you can use it later. Note that the models in the `data/ml_results` will get updated as you forecast using real-time data.

For example, the following copies the new model to `etc/prebuilt_models` that contains the models included in this bundle distribution.

```bash
cp data/ml_results/model_temperature* etc/prebuilt_models/
```

### 4. Submit job

Submit a new job that will invoke the model (Python) with your real-time data by specifying the `--feature` and `--journal` options.

```bash
export CLASSPATH=
switch_cluster ml_jet
cd_app ml_lstm
hz-cli -t ml_jet@localhost:5701 submit target/ml-lstm-1.0.0.jar --feature temperature --journal journal_myforecasts
```            

### 5. Stream real-time data

Ingest real-time data into a map with `event-journal` enabled. For this bundle, any map name that begins with the prefix, `journal`, is `event-journal` enabled.

```
cd_cluster ml_jet
cat etc/hazelcast.yaml
```

```yaml
hazelcast:
...
  map:
    journal*:
      event-journal:
        enabled: true
...
```

### 6. Monitor forecasts

Run `padogrid.bundle.hazelcast.ml.forecast_monitor` that plots forecasted data by specifying the `--feature` option.

```bash
python -m padogrid.bundle.hazelcast.ml.forecast_monitor --feature temperature
```

---

![PadoGrid](https://github.com/padogrid/padogrid/raw/develop/images/padogrid-3d-16x16.png) [*PadoGrid*](https://github.com/padogrid) | [*Catalogs*](https://github.com/padogrid/catalog-bundles/blob/master/all-catalog.md) | [*Manual*](https://github.com/padogrid/padogrid/wiki) | [*FAQ*](https://github.com/padogrid/padogrid/wiki/faq) | [*Releases*](https://github.com/padogrid/padogrid/releases) | [*Templates*](https://github.com/padogrid/padogrid/wiki/Using-Bundle-Templates) | [*Pods*](https://github.com/padogrid/padogrid/wiki/Understanding-Padogrid-Pods) | [*Kubernetes*](https://github.com/padogrid/padogrid/wiki/Kubernetes) | [*Docker*](https://github.com/padogrid/padogrid/wiki/Docker) | [*Apps*](https://github.com/padogrid/padogrid/wiki/Apps) | [*Quick Start*](https://github.com/padogrid/padogrid/wiki/Quick-Start)
